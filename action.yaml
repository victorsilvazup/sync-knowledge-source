name: 'Sync Knowledge Source'
description: 'Sincroniza arquivos locais com um Knowledge Source na StackSpot'
author: 'Seu Nome'

inputs:
  ks_slug:
    description: 'Slug do Knowledge Source'
    required: true
  files_dir:
    description: 'Diret√≥rio com os arquivos a serem sincronizados'
    required: true
  client_id:
    description: 'Client ID para autentica√ß√£o'
    required: true
  client_secret:
    description: 'Client Secret para autentica√ß√£o'
    required: true
  realm:
    description: 'Client Realm para autentica√ß√£o'
    required: true
  max_workers:
    description: "N√∫mero m√°ximo de workers para upload paralelo"
    required: false
    default: "5"
  retry_count:
    description: "N√∫mero de tentativas em caso de erro"
    required: false
    default: "3"

outputs:
  status:
    description: 'Status da sincroniza√ß√£o'
    value: ${{ steps.sync.outputs.status }}
  files_uploaded:
    description: 'N√∫mero de arquivos enviados'
    value: ${{ steps.sync.outputs.files_uploaded }}
  files_deleted:
    description: 'N√∫mero de arquivos removidos'
    value: ${{ steps.sync.outputs.files_deleted }}

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      shell: bash
      run: |
        echo "üì¶ Instalando depend√™ncias..."
        python -m pip install --upgrade pip
        pip install requests
        echo "‚úÖ Depend√™ncias instaladas"
        pip list

    - name: Run sync script
      id: sync
      shell: bash
      env:
        KS_SLUG: ${{ inputs.ks_slug }}
        FILES_DIR: ${{ inputs.files_dir }}
        CLIENT_ID: ${{ inputs.client_id }}
        CLIENT_SECRET: ${{ inputs.client_secret }}
        REALM: ${{ inputs.realm }}
        MAX_WORKERS: ${{ inputs.max_workers }}
        RETRY_COUNT: ${{ inputs.retry_count }}
        PYTHONUNBUFFERED: '1'
        PYTHONDONTWRITEBYTECODE: '1'
        PYTHONIOENCODING: 'utf-8'
      run: |
        echo "üöÄ Executando script de sincroniza√ß√£o..."
        
        # Executar com tratamento de erro
        if python "${{ github.action_path }}/sync_ks.py"; then
          echo "‚úÖ Script executado com sucesso"
        else
          exit_code=$?
          echo "‚ùå Script falhou com c√≥digo: $exit_code"
          exit $exit_code
        fi